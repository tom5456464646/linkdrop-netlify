<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LinkDrop · Список</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0c10; --card:#111319; --text:#e6e7ea; --muted:#a9adba; --primary:#4e8cff; --stroke:#262937;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f6f7fb; --card:#fff; --text:#101218; --muted:#6b7280; --primary:#2563eb; --stroke:#e5e7eb;
        --shadow: 0 10px 24px rgba(16,18,24,.08);
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 18px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: color-mix(in oklab, var(--bg) 92%, transparent);
      border-bottom: 1px solid var(--stroke);
      backdrop-filter: blur(8px);
    }
    .bar {
      max-width: 900px; margin: 0 auto; padding: 12px 16px;
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
    }
    .title { font-weight: 700; letter-spacing: .2px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      appearance: none; border: 1px solid var(--stroke); background: var(--card); color: var(--text);
      border-radius: 12px; padding: 10px 14px; font: inherit; cursor: pointer;
    }
    .btn.primary { background: var(--primary); color: #fff; border-color: transparent; }
    main { max-width: 900px; margin: 0 auto; padding: 16px; }
    .list { display: grid; gap: 12px; }
    .item {
      background: var(--card); border: 1px solid var(--stroke); border-radius: 14px;
      padding: 14px; box-shadow: var(--shadow);
      display: grid; gap: 8px;
    }
    .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .name { font-weight: 650; word-break: break-word; font-size: clamp(16px, 2.6vw, 20px); }
    .muted { color: var(--muted); font-size: 14px; }
    .go {
      appearance: none; border: 0; background: var(--primary); color: #fff; font-weight: 700;
      border-radius: 12px; padding: 12px 18px; cursor: pointer; font-size: 18px;
      min-width: 160px;
    }
    .empty {
      margin: 28px 0; padding: 22px; border: 1px dashed var(--stroke); border-radius: 14px; color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">Список фильмов</div>
      <div class="actions">
        <a class="btn" href="/">Добавить ссылки</a>
        <button class="btn" id="refresh">Обновить</button>
        <button class="btn primary" id="auto">Авто-обновление: выкл</button>
      </div>
    </div>
  </header>

  <main>
    <div id="list" class="list" aria-live="polite"></div>
  </main>

  <script>
    const listEl = document.getElementById('list');
    const btnRefresh = document.getElementById('refresh');
    const btnAuto = document.getElementById('auto');
    let autoTimer = null;

    function esc(s) {
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function render(items) {
      if (!items.length) {
        listEl.innerHTML = '<div class="empty">Пока пусто. Добавь ссылки на главной странице.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      for (const it of items) {
        const created = new Date((it.created_at || 0) * 1000);
        const wrap = document.createElement('article');
        wrap.className = 'item';
        wrap.innerHTML = `
          <div class="row">
            <div class="name">${esc(it.title || it.url)}</div>
            <button class="go" data-url="${esc(it.url)}">Перейти</button>
          </div>
          <div class="muted">ID ${it.id} · ${created.toLocaleString()}</div>
        `;
        frag.appendChild(wrap);
      }
      listEl.innerHTML = '';
      listEl.appendChild(frag);

      listEl.querySelectorAll('.go').forEach(btn => {
        btn.onclick = () => {
          const url = btn.getAttribute('data-url');
          // На ТВ открываем в этом же окне:
          location.href = url;
        };
      });
    }

    async function load() {
      try {
        const r = await fetch('/api/links', { cache: 'no-store' });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'Ошибка API');
        render(data.items);
      } catch (e) {
        listEl.innerHTML = '<div class="empty">Ошибка загрузки. Нажми «Обновить».</div>';
      }
    }

    btnRefresh.onclick = load;

    btnAuto.onclick = () => {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
        btnAuto.textContent = 'Авто-обновление: выкл';
      } else {
        autoTimer = setInterval(load, 5000); // обновлять каждые 5 сек
        btnAuto.textContent = 'Авто-обновление: вкл';
      }
    };

    // авто-включение, если добавить ?auto=1 к url
    const params = new URLSearchParams(location.search);
    if (params.get('auto')) btnAuto.click();

    load();
  </script>
</body>
</html>
